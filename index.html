<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gestor de sesiones - Calendario de sesiones para tu servicio">
    <title>üìÖ Gestor de Sesiones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
    
    <!-- jsPDF and autoTable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDix3BrvWnoxj4KHYXYDbvipvR4Ogn3hiQ",
            authDomain: "sesionescgd-5507a.firebaseapp.com",
            projectId: "sesionescgd-5507a",
            storageBucket: "sesionescgd-5507a.firebasestorage.app",
            messagingSenderId: "93634870835",
            appId: "1:93634870835:web:16e95a069b6cae5704ad46",
            measurementId: "G-XJX86EPC1M"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Usuarios permitidos
        const USUARIOS_PERMITIDOS = [
            'xmolina@ssib.es',
            'cgdhuse@ssib.es'
        ];
        
        // Hacer disponibles globalmente
        window.db = db;
        window.auth = auth;
        window.USUARIOS_PERMITIDOS = USUARIOS_PERMITIDOS;
        window.firebaseModules = {
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDocs,
            query,
            orderBy,
            serverTimestamp,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        };
    </script>
    
    <style>
        /* Estilos personalizados adicionales */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .sesion-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sesion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 8px;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .sesion-card:hover::before {
            width: 12px;
        }
        
        .sesion-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .sesion-completada {
            background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
            border: 2px solid #E5E7EB;
            opacity: 0.65;
        }
        
        .sesion-completada::before {
            background: linear-gradient(180deg, #9CA3AF 0%, #6B7280 100%);
        }
        
        .sesion-completada:hover {
            opacity: 0.85;
        }
        
        .sesion-pendiente {
            background: linear-gradient(135deg, #FFFEF5 0%, #FEF3C7 100%);
            border: 2px solid #FCD34D;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
        }
        
        .sesion-pendiente::before {
            background: linear-gradient(180deg, #FBBF24 0%, #F59E0B 100%);
        }
        
        .badge-estado {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .badge-completada {
            background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%);
            color: #6B7280;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }
        
        .badge-pendiente {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: #92400E;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            animation: pulse-badge 2s ease-in-out infinite;
        }
        
        @keyframes pulse-badge {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            }
            50% {
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.5);
            }
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 1.1rem;
        }
        
        .icon-fecha {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
            color: #1E40AF;
        }
        
        .icon-tipo {
            background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
            color: #4338CA;
        }
        
        .icon-responsable {
            background: linear-gradient(135deg, #FCE7F3 0%, #FBCFE8 100%);
            color: #BE185D;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            animation: slideUp 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #9CA3AF;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        
        /* Ocultar/mostrar secciones */
        .hidden-section {
            display: none !important;
        }
        
        /* Login screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Modo selecci√≥n para intercambiar */
        .modo-seleccion .sesion-card {
            cursor: pointer;
            position: relative;
        }
        
        .modo-seleccion .sesion-card:not(.sesion-seleccionada):hover::after {
            content: 'Click para seleccionar';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(59, 130, 246, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .sesion-seleccionada {
            outline: 4px solid #3B82F6;
            outline-offset: 4px;
            animation: pulse-selection 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-selection {
            0%, 100% {
                outline-color: #3B82F6;
            }
            50% {
                outline-color: #60A5FA;
            }
        }
        
        .btn-fecha-gestion {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-fecha-gestion:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .fecha-gestion-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px dashed rgba(0, 0, 0, 0.1);
        }
        
        /* Bot√≥n flotante (FAB) */
        .fab-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 999;
            animation: fab-entrance 0.5s ease-out;
        }
        
        .fab-button:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.6);
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
        }
        
        .fab-button:active {
            transform: scale(0.95) rotate(90deg);
        }
        
        @keyframes fab-entrance {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            70% {
                transform: scale(1.2) rotate(20deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        /* Ocultar FAB cuando se est√° en modo intercambio */
        .modo-seleccion ~ .fab-button {
            opacity: 0.3;
            pointer-events: none;
        }
        
        /* Responsive: FAB m√°s peque√±o en m√≥vil */
        @media (max-width: 640px) {
            .fab-button {
                width: 56px;
                height: 56px;
                bottom: 20px;
                right: 20px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Pantalla de Login -->
    <div id="pantallaLogin" class="login-container">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
                    <i class="fas fa-calendar-alt text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Sesiones CGD</h1>
                <p class="text-gray-600">Inicia sesi√≥n para continuar</p>
            </div>
            
            <form id="formLogin" onsubmit="iniciarSesion(event)">
                <!-- Email -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-envelope text-blue-600"></i>
                        Correo Electr√≥nico
                    </label>
                    <input 
                        type="email" 
                        id="inputEmail" 
                        required 
                        placeholder="usuario@ssib.es"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                
                <!-- Password -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-lock text-blue-600"></i>
                        Contrase√±a
                    </label>
                    <input 
                        type="password" 
                        id="inputPassword" 
                        required 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                
                <!-- Error Message -->
                <div id="errorLogin" class="hidden mb-4 p-3 bg-red-50 border-l-4 border-red-500 rounded">
                    <p class="text-red-700 text-sm flex items-center gap-2">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="mensajeErrorLogin"></span>
                    </p>
                </div>
                
                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="btnLogin"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2"
                >
                    <i class="fas fa-sign-in-alt"></i>
                    Iniciar Sesi√≥n
                </button>
            </form>
            
            <div class="mt-6 pt-6 border-t border-gray-200">
                <p class="text-xs text-gray-500 text-center">
                    <i class="fas fa-info-circle"></i>
                    Acceso restringido a usuarios autorizados
                </p>
            </div>
        </div>
    </div>
    
    <!-- Aplicaci√≥n Principal (oculta hasta login) -->
    <div id="appPrincipal" class="hidden-section">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center gap-3">
                            <i class="fas fa-calendar-alt"></i>
                            Sesiones CGD Son Espases
                        </h1>
                        <p class="mt-2 text-blue-100">
                            <i class="fas fa-user"></i>
                            <span id="usuarioActual"></span>
                        </p>
                    </div>
                    <button 
                        onclick="cerrarSesion()" 
                        class="bg-blue-800 hover:bg-blue-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden md:inline">Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8 max-w-4xl">
            
            <!-- Botones de Acci√≥n -->
            <div class="mb-6 flex flex-col md:flex-row gap-3">
                <button onclick="abrirModal()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i>
                    Nueva Sesi√≥n
                </button>
                <button onclick="exportarPDF()" class="flex-1 md:flex-none bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-file-pdf"></i>
                    Exportar a PDF
                </button>
            </div>
            
            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="fas fa-filter"></i>
                    Filtros
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Filtro Estado -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                        <select id="filtroEstado" onchange="aplicarFiltros()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="todas">Todas</option>
                            <option value="pendientes" selected>Pendientes</option>
                            <option value="hechas">Hechas</option>
                        </select>
                    </div>
                    
                    <!-- Filtro A√±o -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">A√±o</label>
                        <select id="filtroAno" onchange="aplicarFiltros()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="todos">Todos los a√±os</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Loader -->
            <div id="loader" class="flex justify-center items-center py-12">
                <div class="loader"></div>
            </div>
            
            <!-- Lista de Sesiones -->
            <div id="listaSesiones" class="space-y-4">
                <!-- Las sesiones se cargar√°n aqu√≠ din√°micamente -->
            </div>
            
            <!-- Mensaje cuando no hay sesiones -->
            <div id="mensajeVacio" class="hidden bg-white rounded-lg shadow-md p-12 text-center">
                <i class="fas fa-calendar-times text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay sesiones</h3>
                <p class="text-gray-500">Crea tu primera sesi√≥n haciendo clic en el bot√≥n "Nueva Sesi√≥n"</p>
            </div>
            
        </main>
        
        <!-- Bot√≥n Flotante (FAB) -->
        <button onclick="abrirModal()" class="fab-button" title="Nueva Sesi√≥n">
            <i class="fas fa-plus"></i>
        </button>
        
    </div>
    
    <!-- Modal A√±adir/Editar Sesi√≥n -->
    <div id="modalSesion" class="modal">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitulo" class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-600"></i>
                    Nueva Sesi√≥n
                </h2>
                <button onclick="cerrarModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="formSesion" onsubmit="guardarSesion(event)">
                <!-- Fecha -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-calendar text-blue-600"></i>
                        Fecha
                    </label>
                    <input type="date" id="inputFecha" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Unidad -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-book text-blue-600"></i>
                        Tipo de sesi√≥n
                    </label>
                    <input type="text" id="inputUnidad" required placeholder="Ej: Unidad 3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Responsable -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user text-blue-600"></i>
                        Responsable
                    </label>
                    <input type="text" id="inputResponsable" required placeholder="Ej: Juan P√©rez" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Botones -->
                <div class="flex gap-3">
                    <button type="button" onclick="cerrarModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmaci√≥n -->
    <div id="modalConfirmacion" class="modal">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">¬øEliminar sesi√≥n?</h3>
                <p class="text-gray-600">Esta acci√≥n no se puede deshacer</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="cerrarModalConfirmacion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Cancelar
                </button>
                <button onclick="confirmarEliminar()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Eliminar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmaci√≥n de Correr Sesiones -->
    <div id="modalCorrerSesiones" class="modal">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-calendar-week text-blue-500 text-5xl mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Correr Sesiones</h3>
                <p class="text-gray-600">Mover todas las sesiones desde una fecha espec√≠fica</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">N√∫mero de semanas a mover</label>
                <input type="number" id="inputSemanasCorrer" value="1" min="-52" max="52" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-xl font-bold">
                <p class="text-xs text-gray-500 mt-2">Positivo = adelante (+7 d√≠as), Negativo = atr√°s (-7 d√≠as)</p>
            </div>
            
            <div id="previsualizacionCorrer" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg max-h-60 overflow-y-auto">
                <!-- Se llenar√° din√°micamente -->
            </div>
            
            <div class="flex gap-3">
                <button onclick="cerrarModalCorrer()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Cancelar
                </button>
                <button onclick="confirmarCorrer()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                    Confirmar y Mover
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Insertar Sesi√≥n -->
    <div id="modalInsertarSesion" class="modal">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-plus-square text-green-600"></i>
                    Insertar Sesi√≥n
                </h2>
                <button onclick="cerrarModalInsertar()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4 p-4 bg-amber-50 border-l-4 border-amber-500 rounded">
                <p class="text-sm text-amber-800">
                    <i class="fas fa-info-circle"></i>
                    Esta sesi√≥n se insertar√° en la fecha <strong id="fechaInsercion"></strong> y todas las sesiones posteriores se mover√°n +7 d√≠as.
                </p>
            </div>
            
            <form id="formInsertarSesion" onsubmit="guardarSesionInsertar(event)">
                <!-- Tipo de sesi√≥n -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-book text-blue-600"></i>
                        Tipo de sesi√≥n
                    </label>
                    <input type="text" id="inputUnidadInsertar" required placeholder="Ej: Formaci√≥n continua" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Responsable -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user text-blue-600"></i>
                        Responsable
                    </label>
                    <input type="text" id="inputResponsableInsertar" required placeholder="Ej: Juan P√©rez" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Sesiones afectadas -->
                <div id="sesionesAfectadasInsertar" class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg max-h-48 overflow-y-auto">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                
                <!-- Botones -->
                <div class="flex gap-3">
                    <button type="button" onclick="cerrarModalInsertar()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition duration-300">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300">
                        Insertar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast Notificaciones -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-all duration-300 z-50">
        <span id="toastMensaje"></span>
    </div>
    
    <script>
        // Variables globales
        let sesionesData = [];
        let sesionIdEditar = null;
        let sesionIdEliminar = null;
        let usuarioActual = null;
        
        // Variables para gesti√≥n de fechas
        let modoIntercambio = false;
        let sesionIntercambioA = null;
        let fechaInsertar = null;
        let fechaCorrer = null;
        
        // Verificar estado de autenticaci√≥n al cargar
        window.addEventListener('load', () => {
            const { onAuthStateChanged } = window.firebaseModules;
            
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    // Usuario autenticado
                    if (window.USUARIOS_PERMITIDOS.includes(user.email)) {
                        usuarioActual = user;
                        mostrarAppPrincipal();
                        cargarSesiones();
                    } else {
                        // Usuario no autorizado
                        mostrarError('Usuario no autorizado para acceder a esta aplicaci√≥n');
                        cerrarSesion();
                    }
                } else {
                    // No hay usuario autenticado
                    mostrarPantallaLogin();
                }
            });
        });
        
        // Mostrar pantalla de login
        function mostrarPantallaLogin() {
            document.getElementById('pantallaLogin').classList.remove('hidden-section');
            document.getElementById('appPrincipal').classList.add('hidden-section');
        }
        
        // Mostrar aplicaci√≥n principal
        function mostrarAppPrincipal() {
            document.getElementById('pantallaLogin').classList.add('hidden-section');
            document.getElementById('appPrincipal').classList.remove('hidden-section');
            
            if (usuarioActual) {
                document.getElementById('usuarioActual').textContent = usuarioActual.email;
            }
        }
        
        // Iniciar sesi√≥n
        async function iniciarSesion(event) {
            event.preventDefault();
            
            const email = document.getElementById('inputEmail').value.trim();
            const password = document.getElementById('inputPassword').value;
            const btnLogin = document.getElementById('btnLogin');
            const errorDiv = document.getElementById('errorLogin');
            
            // Verificar si el usuario est√° en la lista permitida
            if (!window.USUARIOS_PERMITIDOS.includes(email)) {
                mostrarErrorLogin('Este usuario no tiene acceso autorizado');
                return;
            }
            
            // Deshabilitar bot√≥n
            btnLogin.disabled = true;
            btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesi√≥n...';
            errorDiv.classList.add('hidden');
            
            try {
                const { signInWithEmailAndPassword } = window.firebaseModules;
                await signInWithEmailAndPassword(window.auth, email, password);
                
                // El onAuthStateChanged se encargar√° de mostrar la app
                
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                
                let mensaje = 'Error al iniciar sesi√≥n';
                
                switch (error.code) {
                    case 'auth/invalid-email':
                        mensaje = 'Correo electr√≥nico inv√°lido';
                        break;
                    case 'auth/user-disabled':
                        mensaje = 'Usuario deshabilitado';
                        break;
                    case 'auth/user-not-found':
                        mensaje = 'Usuario no encontrado. Contacta al administrador.';
                        break;
                    case 'auth/wrong-password':
                        mensaje = 'Contrase√±a incorrecta';
                        break;
                    case 'auth/invalid-credential':
                        mensaje = 'Credenciales inv√°lidas. Verifica tu email y contrase√±a.';
                        break;
                    case 'auth/too-many-requests':
                        mensaje = 'Demasiados intentos fallidos. Intenta m√°s tarde.';
                        break;
                    default:
                        mensaje = error.message;
                }
                
                mostrarErrorLogin(mensaje);
                
                // Rehabilitar bot√≥n
                btnLogin.disabled = false;
                btnLogin.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
            }
        }
        
        // Mostrar error en login
        function mostrarErrorLogin(mensaje) {
            const errorDiv = document.getElementById('errorLogin');
            const mensajeSpan = document.getElementById('mensajeErrorLogin');
            
            mensajeSpan.textContent = mensaje;
            errorDiv.classList.remove('hidden');
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Cerrar sesi√≥n
        async function cerrarSesion() {
            try {
                const { signOut } = window.firebaseModules;
                await signOut(window.auth);
                
                // Limpiar datos
                sesionesData = [];
                usuarioActual = null;
                
                // Resetear formulario de login
                document.getElementById('formLogin').reset();
                
                // Mostrar login
                mostrarPantallaLogin();
                
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                mostrarToast('Error al cerrar sesi√≥n', 'error');
            }
        }
        
        // Cargar todas las sesiones desde Firebase
        async function cargarSesiones() {
            try {
                document.getElementById('loader').style.display = 'flex';
                document.getElementById('listaSesiones').innerHTML = '';
                document.getElementById('mensajeVacio').classList.add('hidden');
                
                const { collection, getDocs, query, orderBy } = window.firebaseModules;
                const sesionesRef = collection(window.db, 'sesiones');
                const q = query(sesionesRef, orderBy('fecha', 'asc'));
                const querySnapshot = await getDocs(q);
                
                sesionesData = [];
                querySnapshot.forEach((doc) => {
                    sesionesData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Actualizar filtro de a√±os
                actualizarFiltroAnos();
                
                // Aplicar filtros
                aplicarFiltros();
                
                document.getElementById('loader').style.display = 'none';
                
            } catch (error) {
                console.error('Error al cargar sesiones:', error);
                document.getElementById('loader').style.display = 'none';
                mostrarToast('Error al cargar las sesiones', 'error');
            }
        }
        
        // Actualizar opciones del filtro de a√±os
        function actualizarFiltroAnos() {
            const anos = new Set();
            sesionesData.forEach(sesion => {
                if (sesion.fecha) {
                    const ano = new Date(sesion.fecha).getFullYear();
                    anos.add(ano);
                }
            });
            
            const filtroAno = document.getElementById('filtroAno');
            const anoActual = filtroAno.value;
            
            filtroAno.innerHTML = '<option value="todos">Todos los a√±os</option>';
            
            Array.from(anos).sort((a, b) => b - a).forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                filtroAno.appendChild(option);
            });
            
            // Restaurar selecci√≥n previa si existe
            if (anoActual && Array.from(anos).includes(parseInt(anoActual))) {
                filtroAno.value = anoActual;
            }
        }
        
        // Aplicar filtros
        function aplicarFiltros() {
            const filtroAno = document.getElementById('filtroAno').value;
            const filtroEstado = document.getElementById('filtroEstado').value;
            
            let sesionesFiltradas = [...sesionesData];
            
            // Filtrar por a√±o
            if (filtroAno !== 'todos') {
                sesionesFiltradas = sesionesFiltradas.filter(sesion => {
                    const ano = new Date(sesion.fecha).getFullYear();
                    return ano === parseInt(filtroAno);
                });
            }
            
            // Filtrar por estado
            if (filtroEstado === 'pendientes') {
                sesionesFiltradas = sesionesFiltradas.filter(sesion => !sesion.completada);
            } else if (filtroEstado === 'hechas') {
                sesionesFiltradas = sesionesFiltradas.filter(sesion => sesion.completada);
            }
            
            // Ordenar por fecha (siempre ascendente)
            sesionesFiltradas.sort((a, b) => {
                const fechaA = new Date(a.fecha);
                const fechaB = new Date(b.fecha);
                return fechaA - fechaB; // Ascendente (m√°s antiguas primero)
            });
            
            // Renderizar
            renderizarSesiones(sesionesFiltradas);
        }
        
        // Renderizar sesiones en el DOM
        function renderizarSesiones(sesiones) {
            const listaSesiones = document.getElementById('listaSesiones');
            const mensajeVacio = document.getElementById('mensajeVacio');
            
            if (sesiones.length === 0) {
                listaSesiones.innerHTML = '';
                mensajeVacio.classList.remove('hidden');
                return;
            }
            
            mensajeVacio.classList.add('hidden');
            
            // A√±adir clase para modo intercambio
            if (modoIntercambio) {
                listaSesiones.classList.add('modo-seleccion');
            } else {
                listaSesiones.classList.remove('modo-seleccion');
            }
            
            listaSesiones.innerHTML = sesiones.map(sesion => {
                const fecha = new Date(sesion.fecha + 'T00:00:00');
                const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const fechaCorta = fecha.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short'
                });
                
                const claseEstado = sesion.completada ? 'sesion-completada' : 'sesion-pendiente';
                const badgeClase = sesion.completada ? 'badge-completada' : 'badge-pendiente';
                const iconoEstado = sesion.completada ? 
                    '<i class="fas fa-check-circle"></i>' : 
                    '<i class="fas fa-clock"></i>';
                
                // Clase adicional si est√° seleccionada para intercambio
                const claseSeleccionada = (sesionIntercambioA && sesionIntercambioA.id === sesion.id) ? 'sesion-seleccionada' : '';
                const onClickIntercambio = (modoIntercambio && !sesion.completada) ? `onclick="seleccionarParaIntercambio('${sesion.id}')"` : '';
                
                return `
                    <div class="sesion-card ${claseEstado} ${claseSeleccionada} bg-white rounded-xl shadow-lg p-6" ${onClickIntercambio}>
                        <div class="flex justify-between items-start mb-5">
                            <span class="badge-estado ${badgeClase}">
                                ${iconoEstado}
                                ${sesion.completada ? 'Completada' : 'Pendiente'}
                            </span>
                            <div class="flex gap-2">
                                <button onclick="toggleCompletada('${sesion.id}', ${!sesion.completada})" 
                                    class="action-btn bg-blue-50 text-blue-600 hover:bg-blue-100" 
                                    title="${sesion.completada ? 'Marcar como pendiente' : 'Marcar como completada'}">
                                    <i class="fas ${sesion.completada ? 'fa-undo' : 'fa-check'}"></i>
                                </button>
                                <button onclick="editarSesion('${sesion.id}')" 
                                    class="action-btn bg-amber-50 text-amber-600 hover:bg-amber-100" 
                                    title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="abrirModalEliminar('${sesion.id}')" 
                                    class="action-btn bg-red-50 text-red-600 hover:bg-red-100" 
                                    title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="info-row">
                                <div class="info-icon icon-fecha">
                                    <i class="fas fa-calendar-day"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Fecha</div>
                                    <div class="font-bold text-gray-800 text-lg">${fechaFormateada}</div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="info-icon icon-tipo">
                                    <i class="fas fa-graduation-cap"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Tipo de Sesi√≥n</div>
                                    <div class="font-semibold text-gray-800 text-base">${sesion.unidad}</div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="info-icon icon-responsable">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Responsable</div>
                                    <div class="font-semibold text-gray-800 text-base">${sesion.responsable}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n de Gesti√≥n de Fechas (solo pendientes) -->
                        ${!sesion.completada ? `
                        <div class="fecha-gestion-section">
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-3 font-semibold">
                                <i class="fas fa-calendar-week"></i> Gesti√≥n de Fechas
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button onclick="iniciarIntercambio('${sesion.id}')" 
                                    class="btn-fecha-gestion bg-blue-50 text-blue-600 hover:bg-blue-100">
                                    <i class="fas fa-exchange-alt"></i>
                                    Intercambiar
                                </button>
                                <button onclick="abrirModalInsertar('${sesion.fecha}')" 
                                    class="btn-fecha-gestion bg-green-50 text-green-600 hover:bg-green-100">
                                    <i class="fas fa-plus-square"></i>
                                    Insertar aqu√≠
                                </button>
                                <button onclick="abrirModalCorrer('${sesion.fecha}')" 
                                    class="btn-fecha-gestion bg-purple-50 text-purple-600 hover:bg-purple-100">
                                    <i class="fas fa-forward"></i>
                                    Correr desde aqu√≠
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Abrir modal para nueva sesi√≥n
        function abrirModal() {
            sesionIdEditar = null;
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-plus-circle text-blue-600"></i> Nueva Sesi√≥n';
            document.getElementById('formSesion').reset();
            
            // Poner fecha de hoy por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('inputFecha').value = hoy;
            
            document.getElementById('modalSesion').classList.add('active');
        }
        
        // Cerrar modal
        function cerrarModal() {
            document.getElementById('modalSesion').classList.remove('active');
            document.getElementById('formSesion').reset();
            sesionIdEditar = null;
        }
        
        // Guardar sesi√≥n (crear o actualizar)
        async function guardarSesion(event) {
            event.preventDefault();
            
            const fecha = document.getElementById('inputFecha').value;
            const unidad = document.getElementById('inputUnidad').value.trim();
            const responsable = document.getElementById('inputResponsable').value.trim();
            
            if (!fecha || !unidad || !responsable) {
                mostrarToast('Por favor, completa todos los campos', 'error');
                return;
            }
            
            // Validar que sea lunes
            if (!esLunes(fecha)) {
                mostrarToast('La fecha debe ser un lunes', 'error');
                return;
            }
            
            try {
                const { collection, addDoc, updateDoc, doc, serverTimestamp } = window.firebaseModules;
                
                if (sesionIdEditar) {
                    // Actualizar sesi√≥n existente
                    const sesionRef = doc(window.db, 'sesiones', sesionIdEditar);
                    await updateDoc(sesionRef, {
                        fecha,
                        unidad,
                        responsable,
                        updatedAt: serverTimestamp()
                    });
                    mostrarToast('Sesi√≥n actualizada correctamente', 'success');
                } else {
                    // Crear nueva sesi√≥n
                    await addDoc(collection(window.db, 'sesiones'), {
                        fecha,
                        unidad,
                        responsable,
                        completada: false,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    mostrarToast('Sesi√≥n creada correctamente', 'success');
                }
                
                cerrarModal();
                cargarSesiones();
                
            } catch (error) {
                console.error('Error al guardar sesi√≥n:', error);
                mostrarToast('Error al guardar la sesi√≥n', 'error');
            }
        }
        
        // Editar sesi√≥n
        function editarSesion(id) {
            const sesion = sesionesData.find(s => s.id === id);
            if (!sesion) return;
            
            sesionIdEditar = id;
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-edit text-amber-600"></i> Editar Sesi√≥n';
            document.getElementById('inputFecha').value = sesion.fecha;
            document.getElementById('inputUnidad').value = sesion.unidad;
            document.getElementById('inputResponsable').value = sesion.responsable;
            
            document.getElementById('modalSesion').classList.add('active');
        }
        
        // Toggle estado completada
        async function toggleCompletada(id, nuevoEstado) {
            try {
                const { updateDoc, doc, serverTimestamp } = window.firebaseModules;
                const sesionRef = doc(window.db, 'sesiones', id);
                
                await updateDoc(sesionRef, {
                    completada: nuevoEstado,
                    updatedAt: serverTimestamp()
                });
                
                mostrarToast(nuevoEstado ? 'Sesi√≥n marcada como completada' : 'Sesi√≥n marcada como pendiente', 'success');
                cargarSesiones();
                
            } catch (error) {
                console.error('Error al actualizar estado:', error);
                mostrarToast('Error al actualizar el estado', 'error');
            }
        }
        
        // Abrir modal de confirmaci√≥n para eliminar
        function abrirModalEliminar(id) {
            sesionIdEliminar = id;
            document.getElementById('modalConfirmacion').classList.add('active');
        }
        
        // Cerrar modal de confirmaci√≥n
        function cerrarModalConfirmacion() {
            document.getElementById('modalConfirmacion').classList.remove('active');
            sesionIdEliminar = null;
        }
        
        // Confirmar eliminaci√≥n
        async function confirmarEliminar() {
            if (!sesionIdEliminar) return;
            
            try {
                const { deleteDoc, doc } = window.firebaseModules;
                await deleteDoc(doc(window.db, 'sesiones', sesionIdEliminar));
                
                mostrarToast('Sesi√≥n eliminada correctamente', 'success');
                cerrarModalConfirmacion();
                cargarSesiones();
                
            } catch (error) {
                console.error('Error al eliminar sesi√≥n:', error);
                mostrarToast('Error al eliminar la sesi√≥n', 'error');
            }
        }
        
        // Mostrar notificaci√≥n toast
        function mostrarToast(mensaje, tipo = 'success') {
            const toast = document.getElementById('toast');
            const toastMensaje = document.getElementById('toastMensaje');
            
            toastMensaje.textContent = mensaje;
            
            // Colores seg√∫n tipo
            if (tipo === 'success') {
                toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 z-50';
            } else if (tipo === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 z-50';
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
        
        // Exportar a PDF
        function exportarPDF() {
            try {
                // Verificar que jsPDF est√© cargado
                if (typeof window.jspdf === 'undefined') {
                    mostrarToast('Error al cargar la librer√≠a de PDF', 'error');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Obtener filtros actuales
                const filtroAno = document.getElementById('filtroAno').value;
                const filtroEstado = document.getElementById('filtroEstado').value;
                
                // Filtrar sesiones seg√∫n los filtros actuales
                let sesionesFiltradas = [...sesionesData];
                
                if (filtroAno !== 'todos') {
                    sesionesFiltradas = sesionesFiltradas.filter(sesion => {
                        const ano = new Date(sesion.fecha).getFullYear();
                        return ano === parseInt(filtroAno);
                    });
                }
                
                if (filtroEstado === 'pendientes') {
                    sesionesFiltradas = sesionesFiltradas.filter(sesion => !sesion.completada);
                } else if (filtroEstado === 'hechas') {
                    sesionesFiltradas = sesionesFiltradas.filter(sesion => sesion.completada);
                }
                
                // Ordenar por fecha ascendente
                sesionesFiltradas.sort((a, b) => {
                    const fechaA = new Date(a.fecha);
                    const fechaB = new Date(b.fecha);
                    return fechaA - fechaB;
                });
                
                // Verificar si hay datos
                if (sesionesFiltradas.length === 0) {
                    mostrarToast('No hay sesiones para exportar con los filtros actuales', 'error');
                    return;
                }
                
                // Configuraci√≥n de colores
                const colorPrimario = [59, 130, 246]; // Azul
                const colorSecundario = [107, 114, 128]; // Gris
                
                // Encabezado
                doc.setFillColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.rect(0, 0, 210, 35, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text('Sesiones CGD Son Espases', 105, 15, { align: 'center' });
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text('Informe de Sesiones', 105, 23, { align: 'center' });
                
                // Informaci√≥n de filtros
                const fechaGeneracion = new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                doc.text(`Generado el: ${fechaGeneracion}`, 105, 30, { align: 'center' });
                
                // Informaci√≥n adicional
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                let infoY = 42;
                
                let filtrosTexto = 'Filtros aplicados: ';
                if (filtroEstado === 'pendientes') {
                    filtrosTexto += 'Pendientes';
                } else if (filtroEstado === 'hechas') {
                    filtrosTexto += 'Completadas';
                } else {
                    filtrosTexto += 'Todas';
                }
                
                if (filtroAno !== 'todos') {
                    filtrosTexto += ` | A√±o ${filtroAno}`;
                }
                
                doc.text(filtrosTexto, 14, infoY);
                doc.text(`Total de sesiones: ${sesionesFiltradas.length}`, 14, infoY + 5);
                
                // Preparar datos para la tabla (SIN columna Estado)
                const tableData = sesionesFiltradas.map(sesion => {
                    const fecha = new Date(sesion.fecha + 'T00:00:00');
                    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    
                    return [
                        fechaFormateada,
                        sesion.unidad || '-',
                        sesion.responsable || '-'
                    ];
                });
                
                // Crear tabla con autoTable
                doc.autoTable({
                    startY: infoY + 12,
                    head: [['Fecha', 'Tipo de Sesi√≥n', 'Responsable']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: colorPrimario,
                        textColor: [255, 255, 255],
                        fontSize: 11,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 10,
                        textColor: [50, 50, 50]
                    },
                    columnStyles: {
                        0: { cellWidth: 35, halign: 'center' },
                        1: { cellWidth: 80 },
                        2: { cellWidth: 65 }
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    margin: { left: 14, right: 14 }
                });
                
                // Pie de p√°gina
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `P√°gina ${i} de ${pageCount}`,
                        105,
                        287,
                        { align: 'center' }
                    );
                    
                    // Usuario que gener√≥ el reporte
                    if (usuarioActual) {
                        doc.text(
                            `Generado por: ${usuarioActual.email}`,
                            14,
                            287
                        );
                    }
                }
                
                // Generar nombre del archivo
                let nombreArchivo = 'Sesiones_CGD';
                if (filtroEstado === 'pendientes') {
                    nombreArchivo += '_Pendientes';
                } else if (filtroEstado === 'hechas') {
                    nombreArchivo += '_Completadas';
                }
                if (filtroAno !== 'todos') {
                    nombreArchivo += `_${filtroAno}`;
                }
                nombreArchivo += '.pdf';
                
                // Guardar PDF
                doc.save(nombreArchivo);
                
                mostrarToast('PDF generado correctamente', 'success');
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                mostrarToast('Error al generar el PDF', 'error');
            }
        }
        
        // ============================================
        // FUNCIONES DE GESTI√ìN DE FECHAS
        // ============================================
        
        // Verificar si una fecha es lunes
        function esLunes(fechaStr) {
            const [year, month, day] = fechaStr.split('-').map(Number);
            const fecha = new Date(year, month - 1, day);
            return fecha.getDay() === 1; // 1 = lunes
        }
        
        // Obtener pr√≥ximo lunes desde una fecha
        function obtenerProximoLunes(fechaStr) {
            const [year, month, day] = fechaStr.split('-').map(Number);
            const fecha = new Date(year, month - 1, day);
            const dia = fecha.getDay();
            const diasHastaLunes = dia === 0 ? 1 : (8 - dia) % 7 || 7;
            fecha.setDate(fecha.getDate() + diasHastaLunes);
            
            const y = fecha.getFullYear();
            const m = String(fecha.getMonth() + 1).padStart(2, '0');
            const d = String(fecha.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        // Sumar d√≠as a una fecha (m√∫ltiplo de 7) - Manejo correcto de fechas locales
        function sumarDias(fechaStr, dias) {
            // Usar manipulaci√≥n directa de strings para evitar problemas de zona horaria
            const [year, month, day] = fechaStr.split('-').map(Number);
            const fecha = new Date(year, month - 1, day); // Mes base 0
            fecha.setDate(fecha.getDate() + dias);
            
            // Formatear manualmente a YYYY-MM-DD
            const y = fecha.getFullYear();
            const m = String(fecha.getMonth() + 1).padStart(2, '0');
            const d = String(fecha.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        // Convertir fecha string a objeto Date local (sin zona horaria)
        function fechaStrToDate(fechaStr) {
            const [year, month, day] = fechaStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }
        
        // ============================================
        // 1. INTERCAMBIAR SESIONES
        // ============================================
        
        function iniciarIntercambio(sesionId) {
            const sesion = sesionesData.find(s => s.id === sesionId);
            if (!sesion) return;
            
            modoIntercambio = true;
            sesionIntercambioA = sesion;
            
            aplicarFiltros(); // Re-renderizar con modo activo
            
            mostrarToast(`Selecciona otra sesi√≥n para intercambiar con ${sesion.unidad}`, 'success');
        }
        
        function cancelarIntercambio() {
            modoIntercambio = false;
            sesionIntercambioA = null;
            aplicarFiltros();
        }
        
        async function seleccionarParaIntercambio(sesionIdB) {
            if (!sesionIntercambioA) return;
            if (sesionIntercambioA.id === sesionIdB) {
                // Cancelar si hace clic en la misma
                cancelarIntercambio();
                return;
            }
            
            const sesionB = sesionesData.find(s => s.id === sesionIdB);
            if (!sesionB || sesionB.completada) {
                mostrarToast('Solo puedes intercambiar con sesiones pendientes', 'error');
                return;
            }
            
            // Confirmar intercambio
            const fechaA = fechaStrToDate(sesionIntercambioA.fecha).toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            const fechaB = fechaStrToDate(sesionB.fecha).toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const confirmar = confirm(
                `¬øIntercambiar fechas?\n\n` +
                `‚Ä¢ ${sesionIntercambioA.unidad}\n  ${fechaA} ‚Üí ${fechaB}\n\n` +
                `‚Ä¢ ${sesionB.unidad}\n  ${fechaB} ‚Üí ${fechaA}`
            );
            
            if (!confirmar) {
                cancelarIntercambio();
                return;
            }
            
            try {
                const { updateDoc, doc, serverTimestamp } = window.firebaseModules;
                
                // Intercambiar fechas
                const fechaTemp = sesionIntercambioA.fecha;
                
                await updateDoc(doc(window.db, 'sesiones', sesionIntercambioA.id), {
                    fecha: sesionB.fecha,
                    updatedAt: serverTimestamp()
                });
                
                await updateDoc(doc(window.db, 'sesiones', sesionB.id), {
                    fecha: fechaTemp,
                    updatedAt: serverTimestamp()
                });
                
                mostrarToast('Sesiones intercambiadas correctamente', 'success');
                cancelarIntercambio();
                cargarSesiones();
                
            } catch (error) {
                console.error('Error al intercambiar:', error);
                mostrarToast('Error al intercambiar sesiones', 'error');
                cancelarIntercambio();
            }
        }
        
        // ============================================
        // 2. INSERTAR SESI√ìN Y CORRER LAS DEM√ÅS
        // ============================================
        
        function abrirModalInsertar(fecha) {
            fechaInsertar = fecha;
            
            const fechaObj = fechaStrToDate(fecha);
            const fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            document.getElementById('fechaInsercion').textContent = fechaFormateada;
            
            // Mostrar sesiones que se mover√°n
            const sesionesPosteriores = sesionesData
                .filter(s => !s.completada && s.fecha >= fecha)
                .sort((a, b) => fechaStrToDate(a.fecha) - fechaStrToDate(b.fecha));
            
            const html = sesionesPosteriores.length > 0 ? `
                <div class="text-sm text-gray-700 mb-2 font-semibold">
                    <i class="fas fa-arrow-right"></i>
                    Sesiones que se mover√°n +7 d√≠as (${sesionesPosteriores.length}):
                </div>
                ${sesionesPosteriores.map(s => {
                    const fechaActual = fechaStrToDate(s.fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    const fechaNueva = fechaStrToDate(sumarDias(s.fecha, 7)).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    return `
                        <div class="text-xs text-gray-600 py-1 border-b border-gray-200">
                            <strong>${s.unidad}</strong>: ${fechaActual} ‚Üí ${fechaNueva}
                        </div>
                    `;
                }).join('')}
            ` : '<div class="text-sm text-gray-500">No hay sesiones posteriores para mover</div>';
            
            document.getElementById('sesionesAfectadasInsertar').innerHTML = html;
            document.getElementById('formInsertarSesion').reset();
            document.getElementById('modalInsertarSesion').classList.add('active');
        }
        
        function cerrarModalInsertar() {
            document.getElementById('modalInsertarSesion').classList.remove('active');
            fechaInsertar = null;
        }
        
        async function guardarSesionInsertar(event) {
            event.preventDefault();
            
            const unidad = document.getElementById('inputUnidadInsertar').value.trim();
            const responsable = document.getElementById('inputResponsableInsertar').value.trim();
            
            if (!unidad || !responsable) {
                mostrarToast('Completa todos los campos', 'error');
                return;
            }
            
            try {
                const { collection, addDoc, updateDoc, doc, serverTimestamp } = window.firebaseModules;
                
                // 1. Obtener sesiones posteriores a mover
                const sesionesAMover = sesionesData
                    .filter(s => !s.completada && s.fecha >= fechaInsertar)
                    .sort((a, b) => fechaStrToDate(b.fecha) - fechaStrToDate(a.fecha)); // Descendente para evitar conflictos
                
                // 2. Mover sesiones posteriores +7 d√≠as
                for (const sesion of sesionesAMover) {
                    const nuevaFecha = sumarDias(sesion.fecha, 7);
                    await updateDoc(doc(window.db, 'sesiones', sesion.id), {
                        fecha: nuevaFecha,
                        updatedAt: serverTimestamp()
                    });
                }
                
                // 3. Crear la nueva sesi√≥n en la fecha original
                await addDoc(collection(window.db, 'sesiones'), {
                    fecha: fechaInsertar,
                    unidad,
                    responsable,
                    completada: false,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                mostrarToast(`Sesi√≥n insertada y ${sesionesAMover.length} sesiones movidas`, 'success');
                cerrarModalInsertar();
                cargarSesiones();
                
            } catch (error) {
                console.error('Error al insertar:', error);
                mostrarToast('Error al insertar sesi√≥n', 'error');
            }
        }
        
        // ============================================
        // 3. CORRER SESIONES DESDE UNA FECHA
        // ============================================
        
        function abrirModalCorrer(fecha) {
            fechaCorrer = fecha;
            
            document.getElementById('inputSemanasCorrer').value = 1;
            document.getElementById('modalCorrerSesiones').classList.add('active');
            
            actualizarPrevisualizacionCorrer();
        }
        
        function cerrarModalCorrer() {
            document.getElementById('modalCorrerSesiones').classList.remove('active');
            fechaCorrer = null;
        }
        
        function actualizarPrevisualizacionCorrer() {
            const semanas = parseInt(document.getElementById('inputSemanasCorrer').value) || 0;
            const dias = semanas * 7;
            
            const sesionesAMover = sesionesData
                .filter(s => !s.completada && s.fecha >= fechaCorrer)
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            if (sesionesAMover.length === 0) {
                document.getElementById('previsualizacionCorrer').innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        No hay sesiones pendientes desde esta fecha
                    </div>
                `;
                return;
            }
            
            const direccion = semanas > 0 ? 'adelante' : 'atr√°s';
            const html = `
                <div class="text-sm font-semibold text-blue-700 mb-3">
                    <i class="fas fa-arrow-${semanas > 0 ? 'right' : 'left'}"></i>
                    Se mover√°n ${sesionesAMover.length} sesiones ${Math.abs(semanas)} semana(s) hacia ${direccion}:
                </div>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    ${sesionesAMover.map(s => {
                        const fechaActual = fechaStrToDate(s.fecha).toLocaleDateString('es-ES', { 
                            day: 'numeric', 
                            month: 'short',
                            year: 'numeric'
                        });
                        const fechaNueva = fechaStrToDate(sumarDias(s.fecha, dias)).toLocaleDateString('es-ES', { 
                            day: 'numeric', 
                            month: 'short',
                            year: 'numeric'
                        });
                        return `
                            <div class="text-xs bg-white p-2 rounded border border-blue-200">
                                <div class="font-semibold text-gray-800">${s.unidad}</div>
                                <div class="text-gray-600 flex items-center gap-2 mt-1">
                                    <span>${fechaActual}</span>
                                    <i class="fas fa-arrow-right text-blue-500"></i>
                                    <span class="font-semibold text-blue-600">${fechaNueva}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('previsualizacionCorrer').innerHTML = html;
        }
        
        // Actualizar previsualizaci√≥n cuando cambia el input
        document.getElementById('inputSemanasCorrer')?.addEventListener('input', actualizarPrevisualizacionCorrer);
        
        async function confirmarCorrer() {
            const semanas = parseInt(document.getElementById('inputSemanasCorrer').value);
            
            if (semanas === 0) {
                mostrarToast('Indica cu√°ntas semanas mover', 'error');
                return;
            }
            
            const dias = semanas * 7;
            
            try {
                const { updateDoc, doc, serverTimestamp } = window.firebaseModules;
                
                const sesionesAMover = sesionesData
                    .filter(s => !s.completada && s.fecha >= fechaCorrer)
                    .sort((a, b) => {
                        // Si es negativo (retroceder), procesar de m√°s antigua a m√°s reciente
                        // Si es positivo (adelantar), procesar de m√°s reciente a m√°s antigua
                        return semanas < 0 ? 
                            fechaStrToDate(a.fecha) - fechaStrToDate(b.fecha) : 
                            fechaStrToDate(b.fecha) - fechaStrToDate(a.fecha);
                    });
                
                if (sesionesAMover.length === 0) {
                    mostrarToast('No hay sesiones para mover', 'error');
                    return;
                }
                
                // Mover todas las sesiones
                for (const sesion of sesionesAMover) {
                    const nuevaFecha = sumarDias(sesion.fecha, dias);
                    await updateDoc(doc(window.db, 'sesiones', sesion.id), {
                        fecha: nuevaFecha,
                        updatedAt: serverTimestamp()
                    });
                }
                
                mostrarToast(`${sesionesAMover.length} sesiones movidas ${Math.abs(semanas)} semana(s)`, 'success');
                cerrarModalCorrer();
                cargarSesiones();
                
            } catch (error) {
                console.error('Error al correr sesiones:', error);
                mostrarToast('Error al mover sesiones', 'error');
            }
        }
        
        // Cerrar modales al hacer clic fuera
        document.getElementById('modalSesion').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });
        
        document.getElementById('modalConfirmacion').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalConfirmacion();
            }
        });
        
        document.getElementById('modalInsertarSesion')?.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalInsertar();
            }
        });
        
        document.getElementById('modalCorrerSesiones')?.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalCorrer();
            }
        });
    </script>
</body>
</html>